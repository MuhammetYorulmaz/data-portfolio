# Exploring Russian Airlines Data: SQL Case Studies

This document provides documentation for each SQL query written for analysis in the Russian Airlines database.

## Database Overview

The data used for these SQL case studies comes from the Russian Airlines demo database, which is specifically designed to showcase various PostgreSQL functionalities for developers. The database contains tables related to airlines, flights, airports, tickets, and more, offering a comprehensive view of airline operations.

You can explore and download the database from the official source here: [Russian Airlines Demo Database](https://postgrespro.com/community/demodb).

### Entity-Relationship Diagram (ERD)
![ERD](../docs/Entity-Relationship-Diagram.png)


## CASE 1: Flight Delay Analysis
**Goal**: Identify the airports with the lowest average delay for flights.

### Query:
```sql
WITH DELAYS AS (
    SELECT F.DEPARTURE_AIRPORT,
           AD.AIRPORT_NAME ->> 'en' AS AIRPORT_NAME_IN_ENGLISH,
           AVG(F.ACTUAL_DEPARTURE - F.SCHEDULED_DEPARTURE) AS AVG_DELAY_TIME
    FROM AIRPORTS_DATA AD
    JOIN FLIGHTS F ON AD.AIRPORT_CODE = F.DEPARTURE_AIRPORT
    GROUP BY F.DEPARTURE_AIRPORT, AD.AIRPORT_NAME
)
SELECT *
FROM DELAYS
ORDER BY AVG_DELAY_TIME;
```

### Result:

| DEPARTURE_AIRPORT | AIRPORT_NAME_IN_ENGLISH   | AVG_DELAY_TIME     |
| ----------------- | --------------------------| -------------------|
| OSW               | Orsk Airport              | 00:07:29.282297    |
| IWA               | Ivanovo South Airport     | 00:09:45.714286    |
| UUA               | Bugulma Airport           | 00:09:54.316940    |
| LPK               | Lipetsk Airport           | 00:10:25.877863    |
| SLY               | Salekhard Airport         | 00:10:29.016393    |

## CASE 2: Flight Counts by Airport
**Goal**: Calculate the count of flights at each airport for each day of the week within a year.

```sql
WITH UNION_FLIGHTS AS
	(SELECT FLIGHT_ID,
			DEPARTURE_AIRPORT AS AIRPORT_CODE,
			ACTUAL_DEPARTURE AS DATE_OF_FLIGHT_IN_AIRPORT
		FROM FLIGHTS
		WHERE ACTUAL_DEPARTURE IS NOT NULL
		UNION SELECT FLIGHT_ID,
			ARRIVAL_AIRPORT AS AIRPORT_CODE,
			ACTUAL_ARRIVAL AS DATE_OF_FLIGHT_IN_AIRPORT
		FROM FLIGHTS
		WHERE ACTUAL_ARRIVAL IS NOT NULL )
SELECT AD.AIRPORT_NAME ->> 'en' AS AIRPORT_NAME,
	TO_CHAR(UF.DATE_OF_FLIGHT_IN_AIRPORT,'Day') AS DAY_NAME,
	COUNT(*) AS COUNT_FLIGHTS
FROM UNION_FLIGHTS UF
JOIN AIRPORTS_DATA AD ON UF.AIRPORT_CODE = AD.AIRPORT_CODE
WHERE UF.DATE_OF_FLIGHT_IN_AIRPORT <
		(SELECT MIN(DATE_OF_FLIGHT_IN_AIRPORT)
			FROM UNION_FLIGHTS) + INTERVAL '1 year'
GROUP BY AD.AIRPORT_NAME,
	TO_CHAR(UF.DATE_OF_FLIGHT_IN_AIRPORT, 'Day')
ORDER BY AD.AIRPORT_NAME,
CASE TRIM(TO_CHAR(UF.DATE_OF_FLIGHT_IN_AIRPORT, 'Day'))
	WHEN 'Monday' THEN 1
	WHEN 'Tuesday' THEN 2
	WHEN 'Wednesday' THEN 3
	WHEN 'Thursday' THEN 4
	WHEN 'Friday' THEN 5
	WHEN 'Saturday' THEN 6
	ELSE 7
END;
```
### Result

| AIRPORT_NAME     | DAY_NAME   | COUNT_FLIGHTS |
|------------------|------------|---------------|
| Abakan Airport   | Monday     | 371           |
| Abakan Airport   | Tuesday    | 468           |
| Abakan Airport   | Wednesday  | 416           |
| Abakan Airport   | Thursday   | 364           |
| Abakan Airport   | Friday     | 312           |
| Abakan Airport   | Saturday   | 520           |
| Abakan Airport   | Sunday     | 364           |

## CASE 3: Revenue by Airline 
**Goal**: Calculate the total revenue generated by each airline.

```sql
SELECT AD.MODEL ->> 'en' AS MODEL_OF_AIRCRAF,
	SUM(CASE WHEN TF.FARE_CONDITIONS = 'Economy' THEN TF.AMOUNT ELSE 0 END) AS ECONOMY,
	SUM(CASE WHEN TF.FARE_CONDITIONS = 'Business' THEN TF.AMOUNT ELSE 0 END) AS BUSINESS,
	SUM(CASE WHEN TF.FARE_CONDITIONS = 'Comfort' THEN TF.AMOUNT ELSE 0 END) AS COMFORT,
	SUM(TF.AMOUNT) AS TOTAL_REVENUE
FROM FLIGHTS F
JOIN AIRCRAFTS_DATA AD ON F.AIRCRAFT_CODE = AD.AIRCRAFT_CODE
JOIN TICKET_FLIGHTS TF ON F.FLIGHT_ID = TF.FLIGHT_ID
GROUP BY AD.MODEL ->> 'en'
ORDER BY TOTAL_REVENUE;
``` 

### Result
| MODEL_OF_AIRCRAFT  | ECONOMY           | BUSINESS         | COMFORT  | TOTAL_REVENUE    |
|--------------------|-------------------|------------------|----------|------------------|
| Cessna 208 Caravan | 774,760,800.00    | 0                | 0        | 774,760,800.00   |
| Boeing 737-300     | 8,734,408,500.00  | 2,650,213,900.00 | 0        | 11,384,622,400.00|
| Airbus A321-200    | 8,167,849,600.00  | 4,784,280,900.00 | 0        | 12,952,130,500.00|
| Bombardier CRJ-200 | 16,163,741,800.00 | 0                | 0        | 16,163,741,800.00|
| Airbus A319-100    | 13,688,778,400.00 | 8,522,521,700.00 | 0        | 22,211,300,100.00|


## CASE 4: Seat Distribution by Aircraft
**Goal**: Calculate the number and percentage of seats in each fare condition (Economy, Business, Comfort) for different aircraft models.
```sql
SELECT S.AIRCRAFT_CODE,
	AD.MODEL ->> 'en' AS AIRCRAFT_MODEL,
	SUM(CASE WHEN S.FARE_CONDITIONS = 'Economy' THEN 1 ELSE 0 END) AS ECONOMY_SEAT_NUM,
	SUM(CASE WHEN S.FARE_CONDITIONS = 'Business' THEN 1 ELSE 0 END) AS BUSINESS_SEAT_NUM,
	SUM(CASE WHEN S.FARE_CONDITIONS = 'Comfort' THEN 1 ELSE 0 END) AS COMFORT_SEAT_NUM,
	COUNT(*) AS TOTAL_SEAT,
	'%' || ROUND((SUM(CASE WHEN S.FARE_CONDITIONS = 'Economy' THEN 1 ELSE 0 END) * 100.0) / COUNT(*), 2)::VARCHAR(10) AS ECONOMY_SEAT_PERCENTAGE,
    '%' || ROUND((SUM(CASE WHEN S.FARE_CONDITIONS = 'Business' THEN 1 ELSE 0 END) * 100.0) / COUNT(*), 2)::VARCHAR(10) AS BUSINESS_SEAT_PERCENTAGE,
    '%' || ROUND((SUM(CASE WHEN S.FARE_CONDITIONS = 'Comfort' THEN 1 ELSE 0 END) * 100.0) / COUNT(*), 2)::VARCHAR(10) AS COMFORT_SEAT_PERCENTAGE
FROM SEATS S
JOIN AIRCRAFTS_DATA AD ON S.AIRCRAFT_CODE = AD.AIRCRAFT_CODE
GROUP BY S.AIRCRAFT_CODE,
	AD.MODEL ->> 'en';
```
### Result
| AIRCRAFT_CODE | AIRCRAFT_MODEL         | ECONOMY_SEAT_NUM | BUSINESS_SEAT_NUM | COMFORT_SEAT_NUM | TOTAL_SEAT | ECONOMY_SEAT_PERCENTAGE | BUSINESS_SEAT_PERCENTAGE | COMFORT_SEAT_PERCENTAGE |
|---------------|------------------------|------------------|-------------------|------------------|------------|-------------------------|--------------------------|-------------------------|
| 763           | Boeing 767-300          | 192              | 30                | 0                | 222        | %86.49                  | %13.51                   | %0.00                   |
| SU9           | Sukhoi Superjet-100     | 85               | 12                | 0                | 97         | %87.63                  | %12.37                   | %0.00                   |
| 321           | Airbus A321-200         | 142              | 28                | 0                | 170        | %83.53                  | %16.47                   | %0.00                   |
| 319           | Airbus A319-100         | 96               | 20                | 0                | 116        | %82.76                  | %17.24                   | %0.00                   |
| 320           | Airbus A320-200         | 120              | 20                | 0                | 140        | %85.71                  | %14.29                   | %0.00                   |
| CN1           | Cessna 208 Caravan      | 12               | 0                 | 0                | 12         | %100.00                 | %0.00                    | %0.00                   |
| 733           | Boeing 737-300          | 118              | 12                | 0                | 130        | %90.77                  | %9.23                    | %0.00                   |
| CR2           | Bombardier CRJ-200      | 50               | 0                 | 0                | 50         | %100.00                 | %0.00                    | %0.00                   |
| 773           | Boeing 777-300          | 324              | 30                | 48               | 402        | %80.60                  | %7.46                    | %11.94                  |

## CASE 5: Generate a view with details of each flight.
**Goal**: Bring seat occupancy and all details of each flight to make statistical analysis.

```sql
CREATE VIEW FLIGHT_DETAIL_VIEW AS
SELECT F.FLIGHT_ID,
	AD.AIRCRAFT_MODEL,
	F.SCHEDULED_DEPARTURE,
	F.SCHEDULED_ARRIVAL,
	TO_CHAR(F.SCHEDULED_DEPARTURE, 'Day') AS FLIGHT_DAY,
	AID.DEPARTURE_CITY,
	AID.DEPARTURE_AIRPORT_NAME,
	AID.DEPARTURE_AIRPORT_COORDINATES,
	AID_2.ARRIVAL_CITY,
	AID_2.ARRIVAL_AIRPORT_NAME,
	AID_2.ARRIVAL_AIRPORT_COORDINATES,
	FSO.SEAT_OCCUPANCY,
	FSO.SEAT_NUM,
	TO_CHAR(FSO.SEAT_OCCUPANCY::double precision / FSO.SEAT_NUM::double precision * 100::double precision,
			'FM999999999.00'::text) AS RATE_OF_SEAT_PERCENTAGE,
	F.ACTUAL_DEPARTURE - F.SCHEDULED_DEPARTURE AS DELAYED_DEPARTURE,
	F.SCHEDULED_ARRIVAL - F.SCHEDULED_DEPARTURE AS FLIGHT_DURATION
FROM FLIGHTS F
JOIN
	(SELECT TF.FLIGHT_ID,
			COUNT(*) AS SEAT_OCCUPANCY,
			AC.SEAT_NUM
		FROM TICKET_FLIGHTS TF
		JOIN FLIGHTS F ON TF.FLIGHT_ID = F.FLIGHT_ID
		JOIN
			(SELECT AIRCRAFT_CODE,
					COUNT(*) AS SEAT_NUM
				FROM SEATS
				GROUP BY AIRCRAFT_CODE) AC ON F.AIRCRAFT_CODE = AC.AIRCRAFT_CODE
		GROUP BY TF.FLIGHT_ID,
			AC.SEAT_NUM) FSO ON F.FLIGHT_ID = FSO.FLIGHT_ID
JOIN
	(SELECT AIRCRAFT_CODE,
			MODEL ->> 'en'::text AS AIRCRAFT_MODEL
		FROM AIRCRAFTS_DATA) AD ON F.AIRCRAFT_CODE = AD.AIRCRAFT_CODE
JOIN
	(SELECT AIRPORT_CODE,
			AIRPORT_NAME ->> 'en'::text AS DEPARTURE_AIRPORT_NAME,
			CITY ->> 'en'::text AS DEPARTURE_CITY,
			COORDINATES AS DEPARTURE_AIRPORT_COORDINATES
		FROM AIRPORTS_DATA) AID ON F.DEPARTURE_AIRPORT = AID.AIRPORT_CODE
JOIN
	(SELECT AIRPORT_CODE,
			AIRPORT_NAME ->> 'en'::text AS ARRIVAL_AIRPORT_NAME,
			CITY ->> 'en'::text AS ARRIVAL_CITY,
			COORDINATES AS ARRIVAL_AIRPORT_COORDINATES
		FROM AIRPORTS_DATA) AID_2 ON F.ARRIVAL_AIRPORT = AID_2.AIRPORT_CODE
WHERE F.ACTUAL_DEPARTURE IS NOT NULL;
```
### Result

| FLIGHT_ID | AIRCRAFT_MODEL | SCHEDULED_DEPARTURE       | SCHEDULED_ARRIVAL         | FLIGHT_DAY | DEPARTURE_CITY | DEPARTURE_AIRPORT_NAME         | DEPARTURE_AIRPORT_COORDINATES           | ARRIVAL_CITY  | ARRIVAL_AIRPORT_NAME   | ARRIVAL_AIRPORT_COORDINATES            | SEAT_OCCUPANCY | SEAT_NUM | RATE_OF_SEAT_PERCENTAGE | DELAYED_DEPARTURE | FLIGHT_DURATION |
|-----------|----------------|---------------------------|---------------------------|------------|----------------|---------------------------------|-----------------------------------------|---------------|-----------------------|-----------------------------------------|----------------|----------|------------------------|-------------------|-----------------|
| 2         | Airbus A321-200 | 2017-06-13 18:05:00+02    | 2017-06-13 19:00:00+02    | Tuesday    | Moscow         | Domodedovo International Airport | (37.90629959106445, 55.40879821777344)  | St. Petersburg | Pulkovo Airport        | (30.262500762939453, 59.80030059814453) | 94             | 170      | 55.29                  | 00:06:00          | 00:55:00        |
| 3         | Airbus A321-200 | 2017-06-13 08:35:00+02    | 2017-06-13 09:30:00+02    | Tuesday    | Moscow         | Domodedovo International Airport | (37.90629959106445, 55.40879821777344)  | St. Petersburg | Pulkovo Airport        | (30.262500762939453, 59.80030059814453) | 97             | 170      | 57.06                  | 00:03:00          | 00:55:00        |
| 7         | Airbus A321-200 | 2017-02-10 17:05:00+01    | 2017-02-10 18:00:00+01    | Friday     | Moscow         | Domodedovo International Airport | (37.90629959106445, 55.40879821777344)  | St. Petersburg | Pulkovo Airport        | (30.262500762939453, 59.80030059814453) | 101            | 170      | 59.41                  | 00:02:00          | 00:55:00        |
| 8         | Airbus A321-200 | 2016-12-08 17:05:00+01    | 2016-12-08 18:00:00+01    | Thursday   | Moscow         | Domodedovo International Airport | (37.90629959106445, 55.40879821777344)  | St. Petersburg | Pulkovo Airport        | (30.262500762939453, 59.80030059814453) | 94             | 170      | 55.29                  | 00:05:00          | 00:55:00        |
| 9         | Airbus A321-200 | 2016-11-26 17:05:00+01    | 2016-11-26 18:00:00+01    | Saturday   | Moscow         | Domodedovo International Airport | (37.90629959106445, 55.40879821777344)  | St. Petersburg | Pulkovo Airport        | (30.262500762939453, 59.80030059814453) | 116            | 170      | 68.24                  | 00:04:00          | 00:55:00        |

## CASE 6: Passenger Trends
**Goal**: Fetch the number of flights, days, months and routes of each passenger

```sql
SELECT T.PASSENGER_ID,
	MAX(T.PASSENGER_NAME) AS PASSENGER_NAME,
	COUNT(TF.FLIGHT_ID) AS TOTAL_FLIGHTS,
	SUM(TF.AMOUNT) AS TOTAL_SPEND,
	STRING_AGG(DISTINCT TF.FARE_CONDITIONS, ', ') AS FARE_CLASSES,	
	STRING_AGG(DISTINCT CONCAT(F.DEPARTURE_AIRPORT, ' -> ', F.ARRIVAL_AIRPORT), ', ') AS ROUTE,
	STRING_AGG(DISTINCT TRIM(TO_CHAR(F.SCHEDULED_DEPARTURE, 'Month')), ', ') AS MONTH_NAME,
	STRING_AGG(DISTINCT TRIM(TO_CHAR(F.SCHEDULED_DEPARTURE, 'Day')), ', ') AS DAY_NAME
FROM TICKETS T
JOIN TICKET_FLIGHTS TF ON T.TICKET_NO = TF.TICKET_NO
JOIN FLIGHTS F ON TF.FLIGHT_ID = F.FLIGHT_ID
GROUP BY T.PASSENGER_ID
ORDER BY TOTAL_FLIGHTS DESC;
```

### Result
| PASSENGER_ID  | PASSENGER_NAME     | TOTAL_FLIGHTS | TOTAL_SPEND | FARE_CLASSES         | ROUTE                                                                 | MONTH_NAME        | DAY_NAME                                  |
|---------------|--------------------|---------------|-------------|----------------------|-----------------------------------------------------------------------|-------------------|-------------------------------------------|
| 0076 080220   | VALENTINA SEMENOVA  | 6             | 172600.00   | Economy              | BQS -> KHV, DYR -> SVO, KHV -> BQS, KHV -> DYR, LED -> KHV, SVO -> LED | June, May         | Saturday, Sunday, Thursday, Wednesday     |
| 0053 535345   | VALENTINA ILINA     | 6             | 47400.00    | Economy              | PEE -> SVX, PEE -> VKO, SGC -> SVX, SVX -> PEE, SVX -> SGC, VKO -> PEE | March             | Monday, Sunday, Tuesday                  |
| 0075 447341   | ELENA FEDOROVA      | 6             | 98200.00    | Business, Economy    | BTK -> DME, BZK -> DME, BZK -> SVO, DME -> BTK, DME -> BZK, SVO -> BZK | June, May         | Monday, Thursday, Tuesday                |
| 0058 471855   | VLADIMIR SOKOLOV    | 6             | 25800.00    | Economy              | AAQ -> EGO, BZK -> EGO, BZK -> VKO, EGO -> AAQ, EGO -> BZK, VKO -> BZK | June, May         | Friday, Saturday, Sunday, Thursday        |
| 0024 986345   | MARIYA RODIONOVA    | 6             | 25800.00    | Economy              | AAQ -> EGO, BZK -> EGO, BZK -> VKO, EGO -> AAQ, EGO -> BZK, VKO -> BZK | November          | Monday, Sunday, Thursday, Tuesday, Wednesday |


## CASE 7: Analyze Seating Arrangement
**Goal**: Analyze seat occupancy percentages by type (aisle, window, middle).

`Before starting the analysis, let's create a view that determines the seat types of each aircraft.`

```sql
CREATE VIEW SEATING_ARRANGEMENT_VIEW AS
SELECT AIRCRAFT_CODE, SEAT_NO, FARE_CONDITIONS, 
	CASE 
		WHEN (RIGHT(SEAT_NO, 1) IN ('A','F')) AND 
			 (AIRCRAFT_CODE IN ('319','320','321','733')) THEN 'window seat'
		WHEN (RIGHT(SEAT_NO, 1) IN ('B','E')) AND 
			 (FARE_CONDITIONS = 'Economy') AND 
			 (AIRCRAFT_CODE IN ('319','320','321','733')) THEN 'middle seat'
		WHEN (RIGHT(SEAT_NO, 1) IN ('C','D')) AND 
			 (AIRCRAFT_CODE IN ('319','320','321','733')) THEN 'aisle seat'
		WHEN (RIGHT(SEAT_NO, 1) IN ('A','H')) AND 
			 (AIRCRAFT_CODE = '763') THEN 'window seat'
		WHEN (RIGHT(SEAT_NO, 1) IN ('B','D','F','G')) AND  
			 (FARE_CONDITIONS = 'Economy') AND 
			 (AIRCRAFT_CODE = '763') THEN 'aisle seat'
		WHEN (RIGHT(SEAT_NO, 1) = 'E') AND  
			 (FARE_CONDITIONS = 'Economy') AND 
			 (AIRCRAFT_CODE = '763') THEN 'middle seat'
		WHEN (RIGHT(SEAT_NO, 1) IN ('B','G')) AND  
			 (FARE_CONDITIONS = 'Business') AND 
			 (AIRCRAFT_CODE = '763') THEN 'middle seat'
		WHEN (RIGHT(SEAT_NO, 1) IN ('C','F')) AND  
			 (FARE_CONDITIONS = 'Business') AND 
			 (AIRCRAFT_CODE = '763') THEN 'aisle seat'
		WHEN (RIGHT(SEAT_NO, 1) IN ('A','K')) AND 
			 (AIRCRAFT_CODE = '773') THEN 'window seat'
		WHEN (RIGHT(SEAT_NO, 1) IN ('C','D','G','H')) AND 
			 (AIRCRAFT_CODE = '773') THEN 'aisle seat'
		WHEN (RIGHT(SEAT_NO, 1) IN ('E','F')) AND  
			 (FARE_CONDITIONS = 'Comfort') AND 
			 (AIRCRAFT_CODE = '773') THEN 'aisle seat'
		WHEN (RIGHT(SEAT_NO, 1) IN ('B','E','F','J')) AND  
			 (FARE_CONDITIONS = 'Economy') AND 
			 (AIRCRAFT_CODE = '773') THEN 'middle seat' 
		WHEN (RIGHT(SEAT_NO, 1) IN ('A','F')) AND 
			 (AIRCRAFT_CODE = 'SU9') THEN 'window seat'
		WHEN (RIGHT(SEAT_NO, 1) IN ('C','D')) AND 
			 (AIRCRAFT_CODE = 'SU9') THEN 'aisle seat'
		WHEN (RIGHT(SEAT_NO, 1) = 'E') AND  
			 (FARE_CONDITIONS = 'Economy') AND 
			 (AIRCRAFT_CODE = 'SU9') THEN 'middle seat'
		WHEN (RIGHT(SEAT_NO, 1) IN ('A','D')) AND 
			 (AIRCRAFT_CODE = 'CR2') THEN 'window seat'
		WHEN (RIGHT(SEAT_NO, 1) IN ('B','C')) AND 
			 (AIRCRAFT_CODE = 'CR2') THEN 'aisle seat'
		WHEN (AIRCRAFT_CODE = 'CN1') THEN 'window seat'
	END AS SEATING_ARRANGEMENT
FROM SEATS;
```

```sql
WITH FLIGHT_SEATING_SUMMARY AS
	(SELECT F.FLIGHT_ID,
			F.AIRCRAFT_CODE,
			SUM(CASE WHEN SAV.SEATING_ARRANGEMENT = 'aisle seat' THEN 1 ELSE 0 END) AS NUMBER_OCCUPIED_AISLE_SEAT,
			SUM(CASE WHEN SAV.SEATING_ARRANGEMENT = 'window seat' THEN 1 ELSE 0 END) AS NUMBER_OCCUPIED_WINDOW_SEAT,
			SUM(CASE WHEN SAV.SEATING_ARRANGEMENT = 'middle seat' THEN 1 ELSE 0 END) AS NUMBER_OCCUPIED_MIDDLE_SEAT,
			COUNT(*) AS NUMBER_OCCUPIED_SEAT
		FROM FLIGHTS F
		JOIN BOARDING_PASSES BP ON F.FLIGHT_ID = BP.FLIGHT_ID
		JOIN SEATING_ARRANGEMENT_VIEW SAV ON F.AIRCRAFT_CODE = SAV.AIRCRAFT_CODE
		AND BP.SEAT_NO = SAV.SEAT_NO
		GROUP BY F.FLIGHT_ID,
			F.AIRCRAFT_CODE),
	SEAT_SUMMARY AS
	(SELECT AIRCRAFT_CODE,
			SUM(CASE WHEN SEATING_ARRANGEMENT = 'window seat' THEN 1 ELSE 0 END) AS TOTAL_WINDOW_SEAT,
			SUM(CASE WHEN SEATING_ARRANGEMENT = 'middle seat' THEN 1 ELSE 0 END) AS TOTAL_MIDDLE_SEAT,
			SUM(CASE WHEN SEATING_ARRANGEMENT = 'aisle seat' THEN 1 ELSE 0 END) AS TOTAL_AISLE_SEAT,
			COUNT(*) AS TOTAL_SEAT
		FROM SEATING_ARRANGEMENT_VIEW
		GROUP BY AIRCRAFT_CODE),
	SEAT_OCCUPANCY_SUMMARY AS
	(SELECT FSS.FLIGHT_ID,
			FSS.AIRCRAFT_CODE,
	 		ROUND((FSS.NUMBER_OCCUPIED_SEAT::numeric / NULLIF(SS.TOTAL_SEAT, 0)::numeric) * 100, 2) AS OCCUPIED_SEAT_PERCENTAGE,
	 		ROUND((FSS.NUMBER_OCCUPIED_WINDOW_SEAT::numeric / NULLIF(SS.TOTAL_WINDOW_SEAT, 0)::numeric) * 100, 2) AS OCCUPIED_WINDOW_SEAT_PERCENTAGE,
			ROUND((FSS.NUMBER_OCCUPIED_MIDDLE_SEAT::numeric / NULLIF(SS.TOTAL_MIDDLE_SEAT, 0)::numeric) * 100, 2) AS OCCUPIED_MIDDLE_SEAT_PERCENTAGE,
	 		ROUND((FSS.NUMBER_OCCUPIED_AISLE_SEAT::numeric / NULLIF(SS.TOTAL_AISLE_SEAT, 0)::numeric) * 100, 2) AS OCCUPIED_AISLE_SEAT_PERCENTAGE
	FROM FLIGHT_SEATING_SUMMARY FSS
	JOIN SEAT_SUMMARY SS ON FSS.AIRCRAFT_CODE = SS.AIRCRAFT_CODE)
SELECT * FROM SEAT_OCCUPANCY_SUMMARY;
```

### Result

| FLIGHT_ID | AIRCRAFT_CODE | OCCUPIED_SEAT_PERCENTAGE | OCCUPIED_WINDOW_SEAT_PERCENTAGE | OCCUPIED_MIDDLE_SEAT_PERCENTAGE | OCCUPIED_AISLE_SEAT_PERCENTAGE |
|-----------|----------------|---------------------------|----------------------------------|----------------------------------|---------------------------------|
| 321       |                | 55.29                     | 51.67                            | 58.33                            | 56.45                           |
| 321       |                | 57.06                     | 61.67                            | 54.17                            | 54.84                           |
| 321       |                | 59.41                     | 60.00                            | 68.75                            | 51.61                           |
| 321       |                | 55.29                     | 48.33                            | 50.00                            | 66.13                           |
| 321       |                | 68.24                     | 70.00                            | 66.67                            | 67.74                           |